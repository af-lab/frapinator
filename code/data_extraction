## Copyright (C) 2010 CarnÃ« Draug <carandraug+dev@gmail.com>
##
## This program is free software; you can redistribute it and/or modify
## it under the terms of the GNU General Public License as published by
## the Free Software Foundation; either version 3 of the License, or
## (at your option) any later version.
##
## This program is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
## GNU General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with this program; if not, see <http://www.gnu.org/licenses/>.

## Calculate timestamps
if (options.flag_timestamps == 0)
  image.timestamps  = linspace (0, options.tScan*(options.nFrames-1), options.nFrames);
elseif (options.flag_timestamps == 1)
  image.timestamps  = read_lsm (file.path);
  if (options.flag_frames)
    options.nFrames = numel(image.timestamps);
  else
    if (numel(image.timestamps) < options.nFrames)
      error ("Number of timestamps found '%g' was larger than the defined number of frames '%g'.", numel(image.timestamps), options.nFrames)
    endif
    options.timestamps = options.timestamps(1:options.nFrames);
  endif
else
  error("Non supported value for flag timestamps. Flag was set to %g", options.flag_timestamps)
endif

## Open the image
image.here = read_image(file.path, file.extension, options.nFrames);
image.here = squeeze (image.here);

if (ndims(image.here) != 3)
  error ("Image from file '%s' has not 3 dimensions. It has %g dimensions. Skipping file", file.path, ndims(image.here));
  clear -exclusive options main paths;
  continue
endif

##Stores info from image
image.height  = rows(image.here);
image.width   = columns(image.here);

## Creates useful slices of the image
image.slice_avg   = uint8( mean(image.here(:,:,options.avg_start:options.avg_end),3));
image.slice_pre   = uint8( mean(image.here(:,:,options.pre_start:options.pre_end),3));
image.slice_post  = uint8( mean(image.here(:,:,options.post_start:options.post_end),3));
image.bleach      = double(image.slice_pre) - double(image.slice_post);
